version: "3"
services:

  tasknet-db:
    image: postgres:9.6
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: username # The PostgreSQL user (useful to connect to the database)
      POSTGRES_PASSWORD: password # The PostgreSQL password (useful to connect to the database)
      POSTGRES_DB: tasknet # The PostgreSQL default database (automatically created at first launch)
    volumes:
      - tasknet_db:/var/lib/postgresql/data/

  database-migrator:
    image: ghcr.io/rust-db/refinery:main
    command:
      - migrate
      - -e
      - DB_URI
      - -p
      - /migrations
    environment:
      DB_URI: postgres://username:password@tasknet-db:5432/tasknet
    volumes:
      - ./tasknet-server/db:/migrations:ro
    depends_on:
      - tasknet-db
    restart: on-failure:5

  server:
    image: jeffas/tasknet-server:0.1.0
    command:
      - --cert-file
      - /var/lib/tasknet-server/certs/server.crt
      - --key-file
      - /var/lib/tasknet-server/certs/server.key
      - --http-listen-address
      - 0.0.0.0:8080
      - --https-listen-address
      - 0.0.0.0:8443
      - --static-files-dir
      - /var/lib/tasknet-server/statics
      - --db-host
      - tasknet-db
    ports:
      - 8080:8080
      - 8443:8443
    volumes:
      - ./certs/:/var/lib/tasknet-server/certs
      - ./tasknet-web/local/:/var/lib/tasknet-server/statics
    environment:
      - RUST_LOG=info
    depends_on:
      - tasknet-db

  kratos-migrate:
    image: oryd/kratos:v0.8.0-alpha.3
    environment:
      - DSN=postgres://kratos:secret@kratos-db:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
    volumes:
      - type: bind
        source: ./email-password
        target: /etc/config/kratos
    command: -c /etc/config/kratos/kratos.yaml migrate sql -e --yes
    restart: on-failure

  kratos:
    depends_on:
      - kratos-migrate
    image: oryd/kratos:v0.8.0-alpha.3
    ports:
      - '4433:4433' # public
      - '4434:4434' # admin
    restart: unless-stopped
    environment:
      - DSN=postgres://kratos:secret@kratos-db:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
      - LOG_LEVEL=trace
    command: serve -c /etc/config/kratos/kratos.yaml --dev --watch-courier
    volumes:
      - type: bind
        source: ./email-password
        target: /etc/config/kratos

  kratos-db:
    image: postgres:9.6
    ports:
      - "8432:5432"
    environment:
      - POSTGRES_USER=kratos
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=kratos
    volumes:
      - kratos_db:/var/lib/postgresql/data/

  mailslurper:
    image: oryd/mailslurper:latest-smtps
    ports:
      - '4436:4436'
      - '4437:4437'


volumes:
  tasknet_db:
  kratos_db:
